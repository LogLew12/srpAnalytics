---
title: "transcriptomics_plots"
author: "Degnan, David J"
date: "2023-04-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, error = FALSE)
library(data.table)
library(plotly)
library(DT)
```

## Read data 

```{r}
transcriptomics <- fread("~/Downloads/transcriptomics_out.txt")
chemical_table <- fread("~/Git_Repos/srpAnalytics/transcriptomics/chemical_table.txt")
```

#### Transcriptomics Data Post Formatting

```{r}
transcriptomics %>%
  head() %>%
  knitr::kable()
```

#### Gene Ontology Post Formatting 



#### Chemical Table

Connects the "comparisons" column to chemical IDs. I have included CAS numbers I 
could find for now. 

```{r}
chemical_table %>%
  head() %>%
  knitr::kable()
```


## Chemical Page Level

#### Counts of Significant Genes per Concentration

```{r}
# As an example, pull chemical
ChemicalID <- "50-32-8"

# Data at the chemical level
chem_level <- transcriptomics[transcriptomics$CASNO == ChemicalID,]

chem_level %>%
  filter(adj_p_value <= 0.05) %>%
  count(Concentration) %>%
  mutate(Concentration = as.factor(Concentration)) %>%
  plot_ly(x = ~Concentration, 
          color = ~Concentration,
          y = ~n,
          type = "bar") %>%
  layout(yaxis = list(title = "Number of Significant Genes"),
         xaxis = list(title = "Concentration in uM"),
         legend = list(title = list(text = "Concentration")))
```

Clicking on this bar chart will trigger changes for the significantly expressed genes.
In other words, all of the following plots in this section "Chemical Page Level"
should change depending on the selected concentration, with the exception of table of 
all genes. 

#### Expression of significant genes 

```{r}
# Concentration selection
Concentration <- 1

chem_level %>%
  filter(Concentration == 1) %>%
  mutate(
    flag = factor(ifelse(adj_p_value <= 0.05, 1, 0) * ifelse(Log2FoldChange >= 0, 1, -1), levels = c(-1, 0, 1)), 
    adj_p_value = -1 * log10(adj_p_value)
  ) %>%
  plot_ly(x = ~Log2FoldChange,
          y = ~adj_p_value,
          color = ~flag) %>%
  layout(yaxis = list(title = "-Log10 P-Value"),
         xaxis = list(title = "Log2 Fold Change"),
         legend = list(title = list(text = "Direction")),
         title = list(text = "Selected Concentration is 1uM"))
```

#### Table of all genes 

```{r}
chem_level %>%
  filter(Concentration == 1) %>%
  dplyr::select(-c(condition)) %>%
  dplyr::rename(`Gene ID` = GeneID, `Log2 Fold Change` = Log2FoldChange, `P Value` = adj_p_value, Flag = flag) %>%
  datatable(options = list(scrollX = TRUE))
```

Clicking a row on the table will open a "Gene Page". 

#### Top 10 Ontologies of Significant Genes 



#### Top 10 Pathways of Significant Genes

## Chemical Page Level

Users select their concentration of interest with a drop down. 

#### Expression Across Chemicals: Count

#### Expression Across Chemicals: Fold Change

I'm not sure I want the volcano plots again here - I don't want to confuse people. 

#### Expression Across Chemicals: Table

Clicking a gene in this table will take the user back to the chemical pages. 


