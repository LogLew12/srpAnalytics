---
title: "transcriptomics_plots"
author: "Degnan, David J"
date: "2023-04-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, error = FALSE)
library(data.table)
library(plotly)
library(DT)
```

## Read data 

```{r}
transcriptomics <- fread("~/Downloads/gene.txt")
ontology <- fread("~/Downloads/ontology.txt")
pathway <- fread("~/Downloads/pathway.txt")
```

#### Transcriptomics Data

I could not find chemical IDs for everything, so I just used CASNO (CAS numbers) for now. 

```{r}
transcriptomics %>%
  head(10) %>%
  datatable(options = list(scrollX = TRUE))
```

#### Gene Ontology Data

```{r}
ontology %>% 
  head(10) %>% 
  datatable(options = list(scrollX = TRUE))
```

#### Pathway Data

```{r}
pathway %>%
  head(10) %>%
  datatable(options = list(scrollX = TRUE))
```

## Chemical Page Level

#### Counts of Significant Genes per Concentration

```{r}
# As an example, pull chemical
ChemicalID <- "50-32-8"

# Data at the chemical level
chem_level <- transcriptomics[transcriptomics$Chemical_ID == ChemicalID,]

chem_level %>%
  filter(AdjPValue <= 0.05) %>%
  dplyr::count(Concentration) %>%
  mutate(Concentration = as.factor(Concentration)) %>%
  plot_ly(x = ~Concentration, 
          color = ~Concentration,
          y = ~n,
          type = "bar") %>%
  layout(yaxis = list(title = "Number of Significant Genes"),
         xaxis = list(title = "Concentration in uM"),
         legend = list(title = list(text = "Concentration")))
```

Clicking on this bar chart will trigger changes for the significantly expressed genes.
In other words, all of the following plots in this section "Chemical Page Level"
should change depending on the selected concentration, with the exception of table of 
all genes. 

#### Expression of significant genes 

```{r}
# Concentration selection
SelectComparison <- "50-32-8 1 Zebrafish"

chem_level %>%
  filter(Comparison == SelectComparison) %>%
  mutate(
    Flag = as.factor(Flag),
    AdjPValue = -1 * log10(AdjPValue)
  ) %>%
  plot_ly(x = ~Log2FoldChange,
          y = ~AdjPValue,
          color = ~Flag) %>%
  layout(yaxis = list(title = "-Log10 P-Value"),
         xaxis = list(title = "Log2 Fold Change"),
         legend = list(title = list(text = "Direction")),
         title = list(text = paste("The comparison is: ", SelectComparison)))
```

#### Table of all genes 

```{r}
chem_level %>%
  filter(Comparison == SelectComparison) %>%
  datatable(options = list(scrollX = TRUE))
```

Clicking a row on the table will open a "Gene Page". 

#### Top 10 Ontologies of Significant Genes 

```{r}
ontology %>%
  filter(Comparison == SelectComparison) %>%
  arrange(OntologyType, OntologyCount) %>%
    mutate(Ontology = factor(Ontology, levels = Ontology)) %>%
  plot_ly(x = ~OntologyCount, 
          color = ~OntologyType,
          y = ~Ontology,
          type = "bar",
          hovertext = ~OntologyPValue)  %>%
  layout(xaxis = list(title = "Count"),
         yaxis = list(title = ""),
         legend = list(title = list(text = "Ontology Type")),
         title = list(text = paste("The comparison is: ", SelectComparison)))
```

#### Top 10 Pathways of Significant Genes

```{r}
pathway %>%
  filter(Comparison == "126-72-7 1 Zebrafish") %>%
  arrange(PathwayCount) %>%
  mutate(Pathway = factor(Pathway, levels = Pathway),
         PathwayPValue = as.numeric(PathwayPValue)) %>%
  plot_ly(x = ~PathwayCount,
          y = ~Pathway,
          type = "bar",
          hovertext = ~PathwayPValue)  %>%
  layout(xaxis = list(title = "Count"),
         yaxis = list(title = ""),
         legend = list(title = list(text = "P Value")),
         title = list(text = paste("The comparison is: 126-72-7 1 Zebrafish")))
```

## Chemical Page Level

Users select their concentration of interest with a drop down. 

#### Expression Across Chemicals: Count

```{r}
SelectGene <- "GeneID:414331"

transcriptomics %>%
  filter(GeneID == SelectGene & Flag != 0) %>%
  dplyr::count(Flag) %>%
  rename(Count = n) %>%
  mutate(Gene = SelectGene,
         Flag = as.factor(Flag)) %>%
  plot_ly(x = ~Gene,
          y = ~Count,  
          color = ~Flag,
          type = 'bar') %>%
  layout(yaxis = list(title = 'Count'), legend = list(title = list(text = "Direction")))
  
```

#### Expression Across Chemicals: Fold Change

I'm not sure I want the volcano plots again here - I don't want to confuse people. 

#### Expression Across Chemicals: Table

Clicking a gene in this table will take the user back to the chemical pages with
the proper comparison selected. 

```{r}
transcriptomics %>%
  filter(GeneID == SelectGene) %>%
  select(-c(GeneID, Gene, Gene_URL, Chemical_ID, Species, Concentration)) %>%
  datatable(options = list(scrollX = TRUE))
```

